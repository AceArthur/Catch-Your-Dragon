<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
            <title>CatchYourDragon_GamePage</title>         
            <script  src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>        
            <script type="text/javascript">
                
                var Crack_List = new Array();
                var goForword = true;
                var COUNT = 5;
                var dest_x;
                var dest_y;
                var slope_cos;
                var slope_sin;
                
                $(document).ready(function(){
                      animateDiv();
                      $("#glass").on("click", function(event){
                            if (Crack_List.length <= 10){
                                  draw(event.pageX, event.pageY);
                                  //alert("Left Hammer: "+(10-Crack_List.length));
                                  document.getElementById("harmer").innerHTML = 10-Crack_List.length;
                                  if (Crack_List.length == 10){
                                  alert("Game Over!");
                                  }
                            }
                        //draw(event.pageX, event.pageY);
                        })
                                  
                });
            
            function changeDirection(top, left){
                var oldq = $('#dragon').offset();
                var x1 = oldq.top + 64;
                var y1 = oldq.left + 59;
                var x2 = top;
                var y2 = left;
                var distance = Math.sqrt(Math.pow(y2 - y1, 2) + Math.pow(x2 - x1, 2));
                if(distance <= 100){
                    return true;
                }
                else{
                    return false;
                }
            }
                                  
            function makeNewPosition(top, left){
                                      
                // Get viewport dimensions (remove the dimension of the div)
                //var h = top + 50;
                //var w = left + 50;
                                      
                if(changeDirection(dest_x, dest_y) == true){
                    goForword = true;
                }
                if(goForword == true){
                    //alert("NEW DIRECTION");
                    var h = $(window).height() - 50;
                    var w = $(window).width() - 50;
                    var n_top = Math.floor(Math.random() * h);
                    var n_left = Math.floor(Math.random() * w);
                    while(n_top == top && n_left == left){
                        var n_top = Math.floor(Math.random() * h);
                        var n_left = Math.floor(Math.random() * w);
                    }
                    //var newGoal = setNewDirection();
                    //dest_x = newGoal.n_top;
                    //dest_y = newGoal.n_left;
                    dest_x = n_top;
                    dest_y = n_left;
                    //alert(dest_x);
                    slope_sin = (dest_y - left)/Math.sqrt(Math.pow(dest_y - left, 2) + Math.pow(dest_x - top, 2));
                    slope_cos = (dest_x - top)/Math.sqrt(Math.pow(dest_y - left, 2) + Math.pow(dest_x - top, 2));
                    goForword = false;
                }
                                      
                                      
                //alert(slope_cos, slope_sin);
                var nh = top + 20 * slope_cos;
                var nw = left + 20 * slope_sin;
                //COUNT--;
                return [nh, nw];
                                      
            }
            
            function animateDiv(){
                //var newq = makeNewPosition();
                var oldq = $('#dragon').offset();
                var center_top = oldq.top + 64;
                var center_left = oldq.left + 59;
                //alert("dragon_offset:");
                //alert(center_top);
                var newq = makeNewPosition(oldq.top, oldq.left);
                if(crackDetection(center_top, center_left) == true){
                    alert(" Danger!");
                }
                else{
                    var speed = calcSpeed([oldq.top, oldq.left], newq);
                    
                    $('#dragon').animate({ top: newq[0], left: newq[1] }, speed,
                                         function(){
                                         animateDiv();
                                         });
                }
                
            };
            
            function calcSpeed(prev, next) {
                
                var x = Math.abs(prev[1] - next[1]);
                var y = Math.abs(prev[0] - next[0]);
                
                var greatest = x > y ? x : y;
                
                var speedModifier = 0.1;
                
                var speed = Math.ceil(greatest/speedModifier);
                
                return speed;
                
            };
            
            /* Crack Detection*/
            
            function crackDetection(top, left){
                var signal = false;
                if(Crack_List.length > 0){
                    for(var i = 0; i < Crack_List.length; i++){
                        for(var j = 0; j < Crack_List[i].Edge_List.length; j++){
                            var point_1 = Crack_List[i].Edge_List[j].Point_List[0];
                            var point_2 = Crack_List[i].Edge_List[j].Point_List[1];
                            // threshold
                            var safetyDistance = 10;
                            var x2 = point_2.top;
                            var y2 = point_2.left;
                            var x1 = point_1.top;
                            var y1 = point_1.left;
                            var x0 = top;
                            var y0 = left;
                            var distance = (Math.abs((y2 - y1) * x0 +(x1 - x2) * y0 + ((x2 * y1) -(x1 * y2)))) /
                            (Math.sqrt(Math.pow(y2 - y1, 2) + Math.pow(x1 - x2, 2)));
                            if(distance <= (safetyDistance + 50)){
                                signal = true;
                                return signal;
                            }
                        }
                    }
                }
                
                return signal;
            }
        
            function draw(top, left){
                
                //Structure: Crack_List(Array of cracks) -> Crack(Array of edges, length of 3 or 4) -> Edge(Array of points, length of 2) -> Point(Pair of top & left);
                
                function Crack() {
                    this.Edge_List = new Array();
                }
                function Edge() {
                    this.Point_List = new Array();
                }
                function Point(top,left) {
                    this.top = top;
                    this.left = left;
                }
                
                var num = Math.floor(4);
                var canvas = document.getElementById('canvas');
                if (canvas.getContext) {
                    var ctx = canvas.getContext('2d');
                };
                //alert(num);
                ctx.lineWidth = 5-2*Math.floor(0.5+Math.random());
                ctx.strokeStyle="#FD0";
                ctx.beginPath();
                ctx.arc(top,left,3,0,2*Math.PI,true);
                ctx.fill();
                
                var val = Math.random();
                {
                    var crack = new Crack();
                    
                    for (var j = num-1+Math.floor(0.5+val); j >0; j--) {
                        var edge1 = new Edge();
                        ctx.beginPath();
                        ctx.moveTo(top, left);
                        
                        var point_1 = new Point(top+(Math.sin((2.09-0.5*Math.floor(0.5+val))*j+val*3))*40,left+(Math.cos((2.09-0.5*Math.floor(0.5+val))*j+val*3))*40);
                        var point_2 = new Point(point_1.top+Math.floor((Math.random()-0.5)*70),point_1.left+Math.floor((Math.random()-0.5)*70));
                        //top2=top-Math.floor((1-j)*60);
                        //left2=left+Math.floor((1-j)*60);
                        
                        ctx.lineTo(point_1.top,point_1.left);
                        ctx.lineTo(point_2.top,point_2.left);
                        //ctx.lineTo(top2,left2);
                        //ctx.lineTo(top2+Math.floor((Math.random()-0.5)*(1-j)*90),left2+Math.floor((Math.random()-0.5)*(1-j)*90));
                        
                        ctx.stroke();
                        
                        {
                            edge1.Point_List.push(point_1);
                            edge1.Point_List.push(point_2);
                            crack.Edge_List.push(edge1);
                        }
                        
                    };
                    
                
                    
                    Crack_List.push(crack);
                    //alert(Crack_List.length);
                    
                }
                
               
                
            
            };
                      
            
    </script>
    <link href="css/style.css" rel="stylesheet" type="text/css">
    <link href="css/box_style.css" rel="stylesheet" type="text/css">
    <style type="text/css">
		.label{
			font-size:36px;
			font-style:italic;
			font-weight:bold;
			display:inline-block;          
    </style>
    </head>
    
    <body style="background-image:url(images/bg.png)">
    <div style="display:inline-block; position:fixed; z-index:100; right:75px; top:25px;">
    <span class="label">Score: </span><div id="scoreboard" class="label" style="display:inline-block;">0</div>
    <br />   
    <span class="label">Harmer:</span><div id="harmer" class="label" style="display:inline-block;">10</div>   
    </div>       
        <div id="glass"><img style="width: 100%; height: 100%;" src="images/glass1.png"></div>		     
        <div id="dragon" style="position:fixed; background-color:red; width:50px; height:50px; z-index: -10;">
            <img src="images/dragon.png">
                </div>
        <div id="cvs_div" style="position:fixed; width:1000px; height:100vh; top:0px; left: 0px; z-index: -5;">
            <canvas id="canvas" width="1000", height="1000"></canvas>
        </div>
    </body>
</html>
